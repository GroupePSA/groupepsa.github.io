{% include data-catalog-table.html %}
<link rel="stylesheet" href="{{ '/connected-vehicles/data-catalog/data-catalog-bis.css' | prepend: modules_path| prepend: site.baseurl }}">

<div class="table-header">
  <div class="field" class="search-div">
    <p class="control has-icons-left">
      <input class="input" type="text" placeholder="Search in table" id="table-search" onkeyup="tablesearch(document.getElementById('table-search').value)">
      <span class="icon is-small is-left">
          <i class="fas fa-search" style="color: darkgrey;"></i>
      </span>
    </p>
  </div>
</div>

<link href="https://unpkg.com/tabulator-tables@4.6.3/dist/css/bulma/tabulator_bulma.min.css" rel="stylesheet">
<script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.6.3/dist/js/tabulator.min.js"></script>

<div id="data-catalog"></div>

<script>

function tablesearch(searchInput) {
  table.setFilter([
    {field:"name",type:"!=",value:""},
    [
      {field:"name", type:"like", value:searchInput},
      {field:"domain", type:"like", value:searchInput},
      {field:"description", type:"like", value:searchInput}, 
      {field:"type", type:"like", value:searchInput}, 
      {field:"unit_or_value", type:"like", value:searchInput}, 
      {field:"step", type:"like", value:searchInput}, 
      {field:"update", type:"like", value:searchInput},
      {field:"webportal_v1", type:"like", value:searchInput},
      {field:"webportal_v2", type:"like", value:searchInput},
      {field:"webapi_b2b_v2", type:"like", value:searchInput},
      {field:"webapi_b2b_v3", type:"like", value:searchInput},
      {field:"webapi_b2c_v4", type:"like", value:searchInput}
    ]
]);
}

const domain_categories = {
  alert: "fas fa-exclamation-circle",
  collision: "fas fa-car-crash",
  location: "fas fa-compass",
  maitenance: "fas fa-tools",
  monitor: "fas fa-bell",
  picture: "fas fa-image",
  remote: "fas fa-satellite-dish",
  telemetrie: "fas fa-chart-bar",
  trip: "fas fa-route",
  vehicle_info: "fas fa-info",
  HMI: "fas fa-car-side",
}


function taggify (link, tagColor, tagShortText, tagLongText) {
  if (link) {
    var tagLink = 
    "<div class='data-item-link' title='"+ tagLongText +"'>"+
      "<a href='{{site.baseurl}}"+link+"' target='_blank' >" +
        "<span class='data-item-link-icon'>"+
          "<span class='icon'>"+
            "<i class='"+ tagColor +"'></i>"+
          "</span>"+
        "</span>"+
        "<span class='data-item-link-subtext'> " + tagShortText + " </span>"+
      "</a>"+
    "</div>";
    return tagLink;
  }
  else {
    var tagNotLink = 
    "<span class='tag data-item-available is-dark'>"+
        "<span>"+ 
          tagShortText+
        "</span>"+
     "</span>";
    return tagNotLink;
  }
}

function taggifyWebportal(v1, v2){ 
  if(!v1 && !v2 ){
    return "";
  }
  else{
    var tagAddon;
    if (v1) {
      var tagAddonV1 = taggify(v1, "fas fa-car-side", "v1", "Webportal v1");
      tagAddon = tagAddonV1;
    }
    if (v2) {
      var tagAddonV2 = taggify(v2, "fas fa-car-side", "v2", "Webportal v2");
      tagAddon += tagAddonV2;
    }
    return tagAddon;
  }
};


function taggifyWebapi(v2, v3, v4){ 
  if(!v2 && !v3 && !v4){
    return "";
  }
  else{
    var tagAddon;
    if (v2) {
      var tagAddonV2 = taggify(v2, "fas fa-cloud", "v2", "Web API B2B v2");
      tagAddon = tagAddonV2;
    }
    if (v3) {
      var tagAddonV3 = taggify(v3, "fas fa-cloud", "v3", "Web API B2B v3");
      tagAddon += tagAddonV3;
    }
    if (v4) {
      var tagAddonV4 = taggify(v4, "fas fa-cloud", "v4", "Web API B2C v4");
      tagAddon += tagAddonV4;
    }
  return tagAddon;
  }
};

const types = {
  String: "is-info",
  Strings: "is-info",
  Enum_of_Strings: "is-info",
  Float: "is-primary",
  Floats: "is-primary",
  Integer: "is-success",
  Boolean: "is-warning",
  Object: "is-dark",
  Objects: "is-dark",
}





function taggifyType (type) {
  var typeTag = taggify(false, types[type.replaceAll(' ','_')], type);
  return typeTag;
}

function codify (text) {
  if (text.includes("`")) {
    var textEnum = text.replace(/(`\w+`)/g, function(match) {
      return "<code class='highlighter-rouge'>'" + match.slice(1, -1) + "'</code>"
    })
    return "<code class='highlighter-rouge'>[</code>"+ textEnum + "<code class='highlighter-rouge'>]</code>";
  }
  else {
    return "<code class='highlighter-rouge'>"+ text +"</code>"
  }
  
}

var sectionTitleFormatter = function(cell, formatterParams){ 
  var value = cell.getValue();
  switch (value){
    case "Webportal":
      return value + "&nbsp; <span class='fas fa-car-side'></span>";
      break;
    case "Web API":
      return value + "&nbsp; <span class='fas fa-cloud'></span>";
      break;
  }
};

// document.querySelector('.tabulator-arrow').remove();

var table = new Tabulator("#data-catalog", {
	data:dataCatalog,           //load row data from array
	movableColumns:false,      //allow column order to be changed
	resizableRows:false,       //allow row order to be changed
  resizableColumns:false,       //allow row order to be changed
  selectable:false,
  layout:"fitColumns",
  pagination: "local",
  paginationSize: 8,
  columns:
    [
      {title:"Domain", field:"domain", cssClass:"column-title",editor:"input", headerFilter:"select", headerFilterParams:{values: { "alert":"Alert", "collision":"Collision", "location" : "Location" , "maitenance" : "Maintenance" , "monitor": "Monitor" , "picture": "Picture", "remote":"Remote", "telemetrie":"Telemetrie", "trip": "Trip" , "vehicle_info": "Vehicle Info" , "HMI":"HMI"}}, headerFilterPlaceholder:"Select ↓"},
      {title:"Name", field:"name", cssClass:"column-title", headerFilter:true, headerFilterPlaceholder:"Search..."},
      {title:"Unit/Value", field:"unit_or_value", cssClass:"column-title", headerFilter:true, headerFilterPlaceholder:"Search..."},
      {title:"Type", field:"type", cssClass:"column-title",editor:"input", headerFilter:"select", headerFilterParams:{values: true}, headerFilterPlaceholder:"Select ↓"},
      {title:"Webportal", titleFormatter:sectionTitleFormatter,  columns:[
        {title:"v1", field:"webportal_v1", cssClass:"column-title"},
        {title:"v2", field:"webportal_v2", cssClass:"column-title"},
        ], cssClass:"column-title"
      },
      {title:"Web API", titleFormatter:sectionTitleFormatter, columns:[
        {title:"v2", field:"webapi_b2b_v2", cssClass:"column-title"},
        {title:"v3", field:"webapi_b2b_v3", cssClass:"column-title"},
        {title:"v4", field:"webapi_b2c_v4", cssClass:"column-title"},
        ], cssClass:"column-title",
      },
    ],
    rowFormatter:function(row){
        var element = row.getElement(),
        data = row.getData(),
        cellContents,
        itemCategorieLogo = domain_categories[data.domain],
        elementWebportal = taggifyWebportal(data.webportal_v1, data.webportal_v2),
        elementWebapi = taggifyWebapi(data.webapi_b2b_v2, data.webapi_b2b_v3, data.webapi_b2c_v4),
        elementType = taggifyType(data.type),
        elementUnitValue = codify(data.unit_or_value),
        // data.unit_or_value.replace(/(`\w+`)/g, function(match) {
        //   return "<code class='highlighter-rouge'>" + match.slice(1, -1) + "</code>"
        // }),
        elementWebapi_v2,
        elementWebapi_v3,
        elementWebapi_v4,
        elementWeportal_v1,
        elementWeportal_v2;

        //clear current row data
        while(element.firstChild) element.removeChild(element.firstChild);

        // create new row data
        cellContents = 
        "<div class='data-item'>"+
          "<div class='data-item-category'>"+
            "<span title='API Domain: "+ data.domain.replace("_", " ") +"' class='icon is-large'>"+
              "<i class='fa "+ itemCategorieLogo +"'></i>"+
            "</span>"+
            "<span class='data-item-domain-name'>" + data.domain.replace("vehicle_info", "Vechicle<br>Info") + "</span>"+
          "</div>"+
            "<div class='data-item-content'>"+
              "<div class='data-item-info'>"+
                "<div class='data-item-title'>" + data.name + "</div>"+
                "<div class='data-item-description'>"+ data.description +"</div>"+
              "</div>"+
              "<div  class='data-item-technical'>"+
                "<div class='data-item-type'>"+
                  "<span class='data-item-fiel-title'>Type:&nbsp;</span>"+ 
                  "<span>" + elementType + "</span>"+
                "</div>"+
                "<div class='data-item-unit_value'>"+
                  "<span class='data-item-fiel-title'>Unit/Value:&nbsp;</span>"+ 
                  "<span>" + elementUnitValue + "</span>"+
                "</div>"+
              "</div>"+
              "<nav class='data-item-avalability'>"+

                "<div class='data-item-links'>"+
                  elementWebportal+
                  elementWebapi +
                "</div>"+

              "</nav>"+
            "</div>";

        
        var dataItemElement = document.createElement("div");
        dataItemElement.innerHTML = cellContents ;

        //append newly formatted contents to the row
        element.append(dataItemElement);
    },
});

{% if page.subsection == "api-data" %}
table.setFilter("domain", "like", "{{page.search-catalog-keyword}}")
{% endif %}

</script>

